<div class="container mt-4">

  <!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="fw-bold mb-0">
    <i class="bi bi-journal-text me-2"></i> Entity Audit Logs
  </h3>
  <div class="d-flex gap-2">
    <button class="btn btn-success" (click)="exportAuditLogs()">
      <i class="bi bi-file-earmark-excel me-1"></i> Export
    </button>
    <button class="btn btn-outline-secondary" (click)="loadEntityLogs()">
      <i class="bi bi-arrow-repeat me-1"></i> Refresh
    </button>
  </div>
</div>


   <!-- Search Filters -->
  <div class="row g-2 mb-3">
    <div class="col-md-6">
      <input type="text"
             class="form-control form-control-sm"
             placeholder="Search by user, action, or entity..."
             [(ngModel)]="qValue">
    </div>
    <div class="col-md-6">
      <input type="date"
             class="form-control form-control-sm"
             [(ngModel)]="dateFilter">
    </div>
  </div>
  <div class="card p-3 shadow-sm">

    <!-- Audit Logs Table -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Timestamp</th>
            <th class="text-end">View</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let log of page()">
            <td>{{ log.userName }}</td>
            <td>
              <span class="badge bg-warning-subtle text-warning border px-3 py-2 rounded-pill shadow-sm">
                {{ log.action }}
              </span>
            </td>
            <td>{{ log.entityName }}</td>
            <td>{{ log.timestamp | date:'short' }}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary" (click)="viewEntityLog(log)">
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="page().length === 0">
            <td colspan="5" class="text-center text-muted py-4">No logs found</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <small class="text-secondary">
        Showing {{ (currentPage() - 1) * pageSize() + 1 }}â€“
        {{ Math.min(currentPage() * pageSize(), filtered().length) }}
        of {{ filtered().length }}
      </small>

      <div class="btn-group">
        <button class="btn btn-outline-light btn-sm"
                [disabled]="currentPage() === 1"
                (click)="prevPage()">Prev</button>
        <button class="btn btn-outline-light btn-sm"
                [disabled]="currentPage() * pageSize() >= filtered().length"
                (click)="nextPage()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="auditLogModal" tabindex="-1" aria-labelledby="auditLogModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4 overflow-hidden bg-body-tertiary">

      <!-- Header -->
      <div class="modal-header border-0 bg-dark text-white py-3">
        <h5 class="modal-title fw-semibold d-flex align-items-center gap-2" id="auditLogModalLabel">
          <i class="bi bi-activity fs-5 text-info"></i> Entity Audit Log
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body bg-white px-4 py-4" style="max-height: 70vh; overflow-y: auto;">
        <div *ngIf="selectedLog" class="p-4 rounded-4 bg-light border shadow-sm position-relative">

          <!-- Badge -->
          <span class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-info-subtle text-info border shadow-sm px-3">
            Log Details
          </span>

          <!-- Info Rows -->
          <div class="row g-4 mt-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-circle text-secondary fs-5"></i>
                <div>
                  <div class="text-muted small fw-semibold">User</div>
                  <div class="fw-bold">{{ selectedLog.userName }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-lightning-charge-fill text-warning fs-5"></i>
                <div>
                  <div class="text-muted small fw-semibold">Action</div>
                  <span class="badge bg-warning-subtle text-warning fw-semibold px-3 py-2 rounded-pill shadow-sm">
                    {{ selectedLog.action }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-4 mt-2">
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-database-fill text-info fs-5"></i>
                <div>
                  <div class="text-muted small fw-semibold">Entity</div>
                  <div class="fw-bold text-info">{{ selectedLog.entityName }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-clock-history text-muted fs-5"></i>
                <div>
                  <div class="text-muted small fw-semibold">Timestamp</div>
                  <div class="text-muted">{{ selectedLog.timestamp | date:'medium' }}</div>
                </div>
              </div>
            </div>
          </div>

          <hr class="border-light my-4">

          <!-- Changed Columns -->
          <div *ngIf="selectedLog.changedColumns" class="mb-3">
            <div class="text-muted small fw-semibold mb-1">Changed Columns</div>
            <div class="d-flex flex-wrap gap-2">
              <span class="badge bg-secondary-subtle text-secondary border rounded-pill shadow-sm">
                {{ selectedLog.changedColumns }}
              </span>
            </div>
          </div>

          <!-- Old Values -->
          <div *ngIf="selectedLog.oldValues" class="mb-3">
            <div class="text-muted small fw-semibold mb-2">Old Values</div>
            <pre class="code-box bg-dark text-light p-3 rounded-3 shadow-sm small">{{ selectedLog.oldValues }}</pre>
          </div>

          <!-- New Values -->
          <div *ngIf="selectedLog.newValues">
            <div class="text-muted small fw-semibold mb-2">New Values</div>
            <pre class="code-box bg-success-subtle text-success p-3 rounded-3 shadow-sm small">{{ selectedLog.newValues }}</pre>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer border-0 bg-body-secondary d-flex justify-content-between px-4 py-3 rounded-bottom-4">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i> Auto-generated system log for entity changes
        </small>
        <button type="button" class="btn btn-outline-dark rounded-pill px-4" data-bs-dismiss="modal">
          <i class="bi bi-x-lg me-1"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>
