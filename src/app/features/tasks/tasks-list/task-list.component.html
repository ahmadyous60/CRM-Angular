<ng-container *ngIf="mode === 'full'">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Tasks</h3>
      <a routerLink="/tasks/new" class="btn btn-primary" *hasPermission="'Tasks.Add'">
        <i class="bi bi-plus-lg"></i> New Task
      </a>
    </div>

    <!-- Search -->
    <div class="card p-3 mb-3">
      <div class="input-group">
        <input type="text" class="form-control"
               placeholder="Search title"
               [ngModel]="q()"
               (ngModelChange)="q.set($event)">
        <button *ngIf="q()" class="btn btn-outline-secondary" type="button" (click)="q.set('')">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Due Date</th>
            <th>Status</th>
            <!-- <th>Entity</th> -->
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let t of paginated()">
            <td class="truncate" [attr.title]="t.title">{{ t.title }}</td>
            <td class="truncate" [attr.title]="t.description">{{ t.description }}</td>
            <td>{{ t.dueDate | date:'mediumDate' }}</td>
            <td>
              <span class="badge" [ngClass]="t.isCompleted ? 'bg-success' : 'bg-warning text-dark'">
                {{ t.isCompleted ? 'Completed' : 'Pending' }}
              </span>
            </td>
            <!-- <td>{{ t.entityType }} ({{ t.entityId }})</td> -->
            <td class="text-end">
              <div class="d-flex justify-content-end align-items-center gap-1 action-buttons">
                <button class="btn btn-sm btn-outline-primary" title="Edit" (click)="edit(t)" *hasPermission="'Tasks.Edit'">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Delete" (click)="confirmDelete(t.id)" *hasPermission="'Tasks.Delete'">
                  <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" title="View" (click)="view(t)" *hasPermission="'Tasks.View'">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="paginated().length === 0">
            <td colspan="6" class="text-center text-muted">No tasks found</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-2">
      <small class="text-secondary">
        Showing {{startIndex()}}â€“{{endIndex()}} of {{filtered().length}}
      </small>
      <div class="btn-group">
        <button class="btn btn-outline-light btn-sm"
                [disabled]="currentPage()===1"
                (click)="prevPage()">Prev</button>
        <button class="btn btn-outline-light btn-sm"
                [disabled]="currentPage()*pageSize>=filtered().length"
                (click)="nextPage()">Next</button>
      </div>
    </div>
  </ng-container>

  <!-- COMPACT MODE -->
  <ng-container *ngIf="mode === 'compact'">
    <div *ngIf="tasks().length === 0" class="text-muted fst-italic">No tasks yet.</div>
    <ul *ngIf="tasks().length > 0" class="list-group overflow-auto" style="max-height: 300px;">
      <li *ngFor="let t of tasks()" class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ t.title }}</strong><br>
          <span class="text-secondary">{{ t.description }}</span><br>
          <small class="text-muted">{{ t.dueDate | date:'short' }}</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <span [class]="t.isCompleted ? 'badge bg-success' : 'badge bg-warning text-dark'">
            {{ t.isCompleted ? 'Done' : 'Pending' }}
          </span>
          <button class="btn btn-sm btn-outline-primary" (click)="edit(t)" title="Edit">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" (click)="confirmDelete(t.id)" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
          <button class="btn btn-sm btn-outline-info" (click)="view(t)" title="View">
            <i class="bi bi-eye"></i>
          </button>
        </div>
      </li>
    </ul>
  </ng-container>




  <!-- View Task Modal -->
  <div class="modal-backdrop fade show" *ngIf="selectedTask" style="z-index: 2000;"></div>
  <div class="modal fade show d-block" *ngIf="selectedTask" style="z-index: 2001;" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 rounded-4 shadow-lg">
        <div class="modal-header bg-primary text-white rounded-top-4 px-4 py-3">
          <h5 class="modal-title"><i class="bi bi-clipboard-check me-2 fs-5"></i> Task Information</h5>
          <button type="button" class="btn-close btn-close-white" (click)="selectedTask=null"></button>
        </div>
        <div class="modal-body bg-light px-4 py-4">
          <div class="row g-4">
            <div class="col-md-6"><label class="form-label fw-bold small">Title</label>
              <div class="p-3 rounded-3 bg-white border">{{ selectedTask.title }}</div>
            </div>
            <div class="col-md-6"><label class="form-label fw-bold small">Description</label>
              <div class="p-3 rounded-3 bg-white border">{{ selectedTask.description }}</div>
            </div>
            <div class="col-md-6"><label class="form-label fw-bold small">Due Date</label>
              <div class="p-3 rounded-3 bg-white border">{{ selectedTask.dueDate | date:'medium' }}</div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold small">Status</label><br>
              <span class="badge px-3 py-2"
                    [ngClass]="selectedTask.isCompleted ? 'bg-success' : 'bg-warning text-dark'">
                {{ selectedTask .isCompleted ? 'Completed' : 'Pending' }}
              </span>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-white">
          <button type="button" class="btn btn-outline-secondary" (click)="selectedTask=null">
            <i class="bi bi-x-circle me-1"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-backdrop fade show" *ngIf="editing()" style="z-index: 2000;"></div>
  <div class="modal fade show d-block" *ngIf="editing()" style="z-index: 2001;" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form #editForm="ngForm" (ngSubmit)="update()">
          <div class="modal-header">
            <h5 class="modal-title">Update Task</h5>
            <button type="button" class="btn-close" (click)="cancelEdit()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">Title</label>
              <input type="text" class="form-control" [(ngModel)]="editTask!.title" name="title" required>
            </div>
            <div class="mb-3"><label class="form-label">Description</label>
              <textarea class="form-control" [(ngModel)]="editTask!.description" name="description"></textarea>
            </div>
            <div class="mb-3"><label class="form-label">Due Date</label>
              <input type="date" class="form-control" [(ngModel)]="editTask!.dueDate" name="dueDate">
            </div>
            <div class="form-check"><input type="checkbox" class="form-check-input" [(ngModel)]="editTask!.isCompleted" name="isCompleted">
              <label class="form-check-label">Completed</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">Save</button>
            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-backdrop fade show" *ngIf="deleting()" style="z-index: 2000;"></div>
  <div class="modal fade show d-block" *ngIf="deleting()" style="z-index: 2001;" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" (click)="cancelDelete()"></button>
        </div>
        <div class="modal-body">Are you sure you want to delete this task?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
          <button class="btn btn-danger" (click)="deleteConfirmed()">Delete</button>
        </div>
      </div>
    </div>
  </div>